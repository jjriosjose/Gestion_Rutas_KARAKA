<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Ruta Karaka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100%; }
        #panel {
            position: absolute; top: 50px; left: 10px; z-index: 1000;
            width: 280px; max-height: 95%; overflow-y: auto;
            padding: 15px; background: white; border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); font-size: 14px;
        }
        #panel-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 1001;
            background-color: #343a40; color: white;
            border-radius: 25px; padding: 8px 12px;
            cursor: pointer; font-weight: bold;
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }
        select, input[type="text"] {
            width: 100%; margin-bottom: 8px; padding: 6px;
            border-radius: 5px; border: 1px solid #ccc;
        }
        button {
            width: 100%; background: #007bff; color: white;
            padding: 8px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold;
        }
        .btn-float {
            position: absolute; right: 15px; bottom: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 999;
        }
        .btn-float button {
            display: flex; align-items: center; gap: 5px;
            padding: 10px 12px; font-size: 14px;
        }
        .registrar { background-color: #007bff; }
        .nuevo { background-color: #28a745; }
        .visitar { background-color: #fd7e14; }
    </style>
</head>
<body>
<div id="panel-toggle">‚ò∞ Filtros</div>
<div id="panel">
    <label>Vendedor</label>
    <select id="filtroVendedor" onchange="aplicarFiltros()"><option value="">-- Todos --</option></select>
    <label>Gestor</label>
    <select id="filtroGestor" onchange="aplicarFiltros()"><option value="">-- Todos --</option></select>
    <label>Semana</label>
    <select id="filtroSemana" onchange="aplicarFiltros()"><option value="">-- Todas --</option></select>
    <label>D√≠a</label>
    <select id="filtroDia" onchange="aplicarFiltros()"><option value="">-- Todos --</option></select>
    <label>Condici√≥n</label>
    <select id="filtroCondicion" onchange="aplicarFiltros()"><option value="">-- Todas --</option></select>
    <label>Buscar Cliente</label>
    <input type="text" id="filtroBuscar" placeholder="Nombre del cliente" oninput="aplicarFiltros()">
    <label>Cliente</label>
    <!-- La llamada a aplicarFiltros se mantiene en el HTML, y ser√° complementada por un listener en el script -->
    <select id="filtroCliente" onchange="aplicarFiltros()"><option value="">-- Todos --</option></select>
    <button id="btnRestaurar">Restaurar</button>
</div>
<div id="map"></div>

<div class="btn-float">
    <button id="btnRegistrar" class="registrar" disabled>üìç Registrar Visita</button>
    <button id="btnNuevo" class="nuevo">‚ûï Nuevo Cliente</button>
    <button id="btnVisitar" class="visitar">üöó Visitar Cliente</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
const URL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnmjSg8mtidztak7cO6Es8tOTRujAes62qA9gsu1FYn219IaLqBpkYlIgZJgDNcpKHATaG9tWqwrE7/pub?output=csv';
let map = L.map('map').setView([18.7357, -70.1627], 8);
let dataOriginal = [];
let capaClientes = L.layerGroup().addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

const colores = ['blue', 'green', 'orange', 'violet', 'black'];
function iconoPorVendedor(vendedor) {
    const vendedores = [...new Set(dataOriginal.map(d => d.vendedor).filter(Boolean))];
    const index = vendedores.indexOf(vendedor);
    const color = colores[index % colores.length];
    return new L.Icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}

function limpiarMarcadores() {
    capaClientes.clearLayers();
}

function cargarFiltros(data) {
    const campos = {
        filtroVendedor: "vendedor",
        filtroGestor: "gestor",
        filtroSemana: "semana",
        filtroDia: "dia",
        filtroCondicion: "condicion",
        filtroCliente: "RazonSocial"
    };
    for (let id in campos) {
        const select = document.getElementById(id);
        const valores = [...new Set(data.map(d => d[campos[id]]).filter(Boolean))].sort();
        select.innerHTML = '<option value="">-- Todos --</option>' + valores.map(v => `<option>${v}</option>`).join('');
    }
}

function aplicarFiltros() {
    const vendedor  = document.getElementById("filtroVendedor").value;
    const gestor    = document.getElementById("filtroGestor").value;
    const semana    = document.getElementById("filtroSemana").value;
    const dia       = document.getElementById("filtroDia").value;
    const condicion = document.getElementById("filtroCondicion").value;
    const buscar    = document.getElementById("filtroBuscar").value.toLowerCase();
    const cliente   = document.getElementById("filtroCliente").value;

    let filtrado;
    if (cliente) {
        // Al seleccionar un cliente, se ignoran otros filtros y s√≥lo se muestra ese cliente (si existe)
        filtrado = dataOriginal.filter(d => {
            return d.RazonSocial === cliente &&
                   (!buscar || (d.RazonSocial && d.RazonSocial.toLowerCase().includes(buscar)));
        });
    } else {
        filtrado = dataOriginal.filter(d => {
            return (!vendedor  || d.vendedor === vendedor) &&
                   (!gestor    || d.gestor === gestor) &&
                   (!semana    || d.semana === semana) &&
                   (!dia       || d.dia === dia) &&
                   (!condicion || d.condicion === condicion) &&
                   (!buscar    || (d.RazonSocial && d.RazonSocial.toLowerCase().includes(buscar)));
        });
    }
    // Actualizar listado de clientes seg√∫n el filtrado
    actualizarFiltroCliente(filtrado, cliente);
    // Mostrar clientes filtrados en el mapa
    mostrarClientes(filtrado);
    // Si hay un cliente seleccionado, centrar y abrir su popup
    if (cliente) {
        const encontrado = dataOriginal.find(d => d.RazonSocial === cliente);
        if (encontrado && encontrado.latitud && encontrado.longitud) {
            map.setView([parseFloat(encontrado.latitud), parseFloat(encontrado.longitud)], 15);
            capaClientes.eachLayer(marker => {
                if (marker.cliente === cliente) marker.openPopup();
            });
        }
    }
}

// Actualiza las opciones del select de Cliente en funci√≥n de los datos filtrados
function actualizarFiltroCliente(datosFiltrados, clienteSeleccionado) {
    const select = document.getElementById('filtroCliente');
    // Obtener lista √∫nica de razones sociales del filtrado
    const clientes = [...new Set(datosFiltrados.map(d => d.RazonSocial).filter(Boolean))].sort();
    // Construir HTML de opciones
    let opciones = '<option value="">-- Todos --</option>';
    clientes.forEach(nombre => {
        opciones += `<option value="${nombre}">${nombre}</option>`;
    });
    select.innerHTML = opciones;
    // Restaurar selecci√≥n si es v√°lida
    if (clienteSeleccionado && clientes.includes(clienteSeleccionado)) {
        select.value = clienteSeleccionado;
    } else {
        select.value = '';
    }
}

function mostrarClientes(clientes) {
    limpiarMarcadores();
    clientes.forEach(c => {
        if (c.latitud && c.longitud) {
            const lat = parseFloat(c.latitud);
            const lng = parseFloat(c.longitud);
            const enlace = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            const popup = `<b>${c.RazonSocial}</b><br>${c.vendedor || ''}<br>${c.gestor || ''}<br><a href="${enlace}" target="_blank">üìç C√≥mo llegar</a>`;
            const marker = L.marker([lat, lng], { icon: iconoPorVendedor(c.vendedor) }).bindPopup(popup);
            marker.lat = lat;
            marker.lng = lng;
            marker.cliente = c.RazonSocial;
            // Pasar el c√≥digo de empresa al marcador, si existe
            marker.codigo = c.cod_empresa || c['Cod Empresa'] || c.CodEmpresa || c.codigo || "";
            capaClientes.addLayer(marker);
        }
    });
}

function restaurarMapa() {
    Papa.parse(URL_CSV, {
        download: true,
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: function(results) {
            dataOriginal = results.data.map(row => ({
                latitud: parseFloat(String(row.latitud || row.LATITUD || row.Latitud || row.LAT).replace(",", ".").trim()),
                longitud: parseFloat(String(row.longitud || row.LONGITUD || row.Longitud || row.LONG).replace(",", ".").trim()),
                vendedor: row.vendedor || row.VENDEDOR || row.Vendedor || "",
                gestor: row.gestor || row.gestor_servicio || row.GESTOR || row.Gestor || "",
                semana: row.semana || row.SEMANA || row.Semana || "",
                dia: row.dia || row.DIA || row.D√≠a || row['dia_visita'] || "",
                condicion: row.condicion || row.CONDICION || row.Condici√≥n || "",
                RazonSocial: row.RazonSocial || row["Raz√≥n Social"] || row.razon_social || row.Cliente || "Cliente sin nombre",
                // Parse the company code from various possible column names. This will be used when pre‚Äërelleno (prefill) the form
                cod_empresa: row['Cod Empresa'] || row['cod_empresa'] || row['Codigo Empresa'] || row['Codigo'] || row['codigo'] || row['ID Empresa'] || row['ID'] || row['id_empresa'] || row['CodEmpresa'] || row['codEmpresa'] || row['codempresa'] || row.codigo || row.CODIGO || row.CODIGO_EMPRESA || row.CODIGOEMPRESA || ""
            })).filter(r => !isNaN(r.latitud) && !isNaN(r.longitud));
            cargarFiltros(dataOriginal);
            mostrarClientes(dataOriginal);
        }
    });
}

document.getElementById('panel-toggle').onclick = () => {
    const panel = document.getElementById('panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
};

// Cargar datos iniciales
restaurarMapa();
</script>

<script>
// Activar/desactivar bot√≥n Registrar sin sobreescribir el onchange del HTML
const clienteSelect = document.getElementById("filtroCliente");
clienteSelect.addEventListener('change', function () {
    const btn = document.getElementById("btnRegistrar");
    btn.disabled = this.value === "";
});

// Bot√≥n Registrar Visita
document.getElementById("btnRegistrar").onclick = function () {
    const cliente = document.getElementById("filtroCliente").value;
    const encontrado = dataOriginal.find(d => d.RazonSocial === cliente);
    if (!encontrado) {
        alert("Debe seleccionar un cliente v√°lido.");
        return;
    }
    if (!navigator.geolocation) {
        alert("Geolocalizaci√≥n no soportada.");
        return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const condicion = encontrado.condicion || "Sin Ruta";
        // Build the prefilled URL for the Google Form.  In addition to the
        // vendedor, gestor, condici√≥n, c√≥digo de empresa y raz√≥n social,
        // the updated form also captures semana y d√≠a via entry IDs
        // 1385874704 (Semana) and 41285940 (D√≠a).
        const url =
            `https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform?usp=pp_url`
            + `&entry.985299062=${encodeURIComponent(encontrado.vendedor || "")}`
            + `&entry.366494420=${encodeURIComponent(encontrado.gestor || "")}`
            + `&entry.381054793=${encodeURIComponent(condicion)}`
            + `&entry.1521955635=${encodeURIComponent(encontrado.cod_empresa || "")}`
            + `&entry.879964686=${encodeURIComponent(encontrado.RazonSocial || "")}`
            + `&entry.1385874704=${encodeURIComponent(encontrado.semana || "")}`
            + `&entry.41285940=${encodeURIComponent(encontrado.dia || "")}`
            + `&entry.1634734772=${encodeURIComponent(lat)}`
            + `&entry.566218311=${encodeURIComponent(lon)}`;
        window.open(url, "_blank");
    });
};

// Bot√≥n Visitar Cliente
document.getElementById("btnVisitar").onclick = function () {
    const cliente = document.getElementById("filtroCliente").value;
    const encontrado = dataOriginal.find(d => d.RazonSocial === cliente);
    if (encontrado && encontrado.latitud && encontrado.longitud) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${encontrado.latitud},${encontrado.longitud}`;
        window.open(url, "_blank");
    } else {
        alert("Debe seleccionar un cliente v√°lido con ubicaci√≥n.");
    }
};

// Bot√≥n Nuevo Cliente
document.getElementById("btnNuevo").onclick = function () {
    if (!navigator.geolocation) {
        alert("Geolocalizaci√≥n no soportada.");
        return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        // Use the selected vendedor from the filter, as well as the semana y d√≠a
        const vendedor = document.getElementById("filtroVendedor").value || "";
        const semanaNuevo = document.getElementById("filtroSemana").value || "";
        const diaNuevo = document.getElementById("filtroDia").value || "";
        const url = `https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform?usp=pp_url`
            + `&entry.985299062=${encodeURIComponent(vendedor)}`
            + `&entry.381054793=NUEVO`
            + `&entry.1385874704=${encodeURIComponent(semanaNuevo)}`
            + `&entry.41285940=${encodeURIComponent(diaNuevo)}`
            + `&entry.1634734772=${encodeURIComponent(lat)}`
            + `&entry.566218311=${encodeURIComponent(lon)}`;
        window.open(url, "_blank");
    });
};

// Bot√≥n Restaurar filtros y mapa
document.getElementById("btnRestaurar").onclick = function () {
    ["filtroVendedor", "filtroGestor", "filtroSemana", "filtroDia", "filtroCondicion", "filtroCliente"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });
    document.getElementById("filtroBuscar").value = "";
    restaurarMapa();
    map.setView([18.7357, -70.1627], 8);
    // Desactivar bot√≥n registrar
    document.getElementById("btnRegistrar").disabled = true;
};
</script>
</body>

</html>