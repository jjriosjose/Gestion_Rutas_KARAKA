<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapa de Clientes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #map { height: 100vh; }
        #panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            font-family: sans-serif;
            font-size: 14px;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
        }
        .checkbox-group label {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="panel">
    <strong>Vendedor:</strong>
    <div class="checkbox-group" id="checkboxVendedores"></div>
    <button onclick="restaurarMapa()">Restaurar Mapa</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const urlDatos = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnmjSg8mtidztak7cO6Es8tOTRujAes62qA9gsu1FYn219IaLqBpkYlIgZJgDNcpKHATaG9tWqwrE7/pub?output=csv";

    const mapa = L.map('map').setView([18.7357, -70.1627], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(mapa);

    let marcadores = [];

    function cargarDatos() {
        fetch(urlDatos)
            .then(res => res.text())
            .then(csv => {
                const [cabecera, ...filas] = csv.trim().split("\n").map(f => f.split(","));
                const vendedores = new Set();
                const datos = filas.map(c => {
                    const obj = {};
                    cabecera.forEach((k, i) => obj[k] = c[i]);
                    vendedores.add(obj["vendedor"]);
                    return obj;
                });

                crearCheckboxVendedores([...vendedores].sort());
                mostrarMarcadores(datos);
            });
    }

    function crearCheckboxVendedores(lista) {
        const contenedor = document.getElementById("checkboxVendedores");
        lista.forEach(nombre => {
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.type = "checkbox";
            input.className = "filtro-vendedor";
            input.value = nombre;
            input.checked = true;
            input.onchange = filtrarMarcadores;
            label.appendChild(input);
            label.appendChild(document.createTextNode(nombre));
            contenedor.appendChild(label);
        });
    }

    function mostrarMarcadores(datos) {
        marcadores = datos.map(c => {
            const marker = L.marker([parseFloat(c.latitud), parseFloat(c.longitud)]).addTo(mapa);
            marker.bindPopup(`<b>${c.RazonSocial}</b><br>${c.vendedor}`);
            marker.options.vendedor = c.vendedor;
            return marker;
        });
    }

    function filtrarMarcadores() {
        const seleccionados = Array.from(document.querySelectorAll(".filtro-vendedor:checked")).map(cb => cb.value);
        marcadores.forEach(m => {
            if (seleccionados.includes(m.options.vendedor)) {
                m.addTo(mapa);
            } else {
                mapa.removeLayer(m);
            }
        });
    }

    function restaurarMapa() {
        document.querySelectorAll(".filtro-vendedor").forEach(cb => cb.checked = true);
        filtrarMarcadores();
    }

    cargarDatos();
</script>
</body>
</html>