
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa Rutas Clientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; right: 0; left: 0; }
    #panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 5px #999;
      max-height: 95vh;
      overflow-y: auto;
      font-family: sans-serif;
      font-size: 14px;
    }
    #panel label { display: block; margin-top: 6px; }
    .checkbox-vendedor {
      display: block;
      margin-left: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <strong>Vendedor:</strong>
    <div id="vendedorCheckboxes"></div>
    <label>Gestor:
      <select id="filtroGestor"><option value="">-- Seleccione --</option></select>
    </label>
    <label>Semana:
      <select id="filtroSemana"><option value="">-- Seleccione --</option></select>
    </label>
    <label>Día de la Semana:
      <select id="filtroDia"><option value="">-- Seleccione --</option></select>
    </label>
    <label>Condición:
      <select id="filtroCondicion">
        <option value="">-- Todos --</option>
        <option value="En Ruta">En Ruta</option>
        <option value="Sin Ruta">Sin Ruta</option>
      </select>
    </label>
    <label>Buscar Cliente:
      <input type="text" id="filtroNombre" placeholder="Escriba el nombre..."/>
    </label>
    <label>Cliente:
      <select id="filtroCliente"><option value="">-- Seleccione --</option></select>
    </label>
    <button onclick="restaurarMapa()">Restaurar Mapa</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let mapa = L.map('map').setView([18.5, -70.0], 8);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(mapa);

    let marcadores = [];
    let datos = [];
    let vendedoresUnicos = new Set();

    async function cargarDatos() {
      try {
        const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnmjSg8mtidztak7cO6Es8tOTRujAes62qA9gsu1FYn219IaLqBpkYlIgZJgDNcpKHATaG9tWqwrE7/pub?output=csv";
        const res = await fetch(urlCSV);
        const texto = await res.text();
        const lineas = texto.split('\n').filter(l => l.trim() !== "");
        const cabeceras = lineas.shift().split(',');

        datos = lineas.map(linea => {
          const valores = linea.split(',');
          let obj = {};
          cabeceras.forEach((key, i) => obj[key.trim()] = valores[i]?.trim());
          vendedoresUnicos.add(obj["vendedor_asignado"]);
          return obj;
        });

        construirCheckboxesVendedor();
        poblarFiltros();
        mostrarMarcadores();
      } catch (e) {
        alert("Error cargando datos del mapa.");
        console.error(e);
      }
    }

    function construirCheckboxesVendedor() {
      const div = document.getElementById("vendedorCheckboxes");
      vendedoresUnicos.forEach(nombre => {
        const lbl = document.createElement("label");
        lbl.className = "checkbox-vendedor";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.value = nombre;
        chk.checked = true;
        chk.onchange = mostrarMarcadores;
        lbl.appendChild(chk);
        lbl.appendChild(document.createTextNode(" " + nombre));
        div.appendChild(lbl);
      });
    }

    function poblarFiltros() {
      const gestor = document.getElementById("filtroGestor");
      const semana = document.getElementById("filtroSemana");
      const dia = document.getElementById("filtroDia");
      const cliente = document.getElementById("filtroCliente");

      let gestores = new Set();
      let semanas = new Set();
      let dias = new Set();
      let clientes = new Set();

      datos.forEach(d => {
        gestores.add(d["gestor_servicio"]);
        semanas.add(d["semana"]);
        dias.add(d["dia_visita"]);
        clientes.add(d["RazonSocial"]);
      });

      gestores.forEach(g => gestor.innerHTML += `<option>${g}</option>`);
      semanas.forEach(s => semana.innerHTML += `<option>${s}</option>`);
      dias.forEach(d => dia.innerHTML += `<option>${d}</option>`);
      clientes.forEach(c => cliente.innerHTML += `<option>${c}</option>`);

      gestor.onchange = mostrarMarcadores;
      semana.onchange = mostrarMarcadores;
      dia.onchange = mostrarMarcadores;
      cliente.onchange = mostrarMarcadores;
      document.getElementById("filtroCondicion").onchange = mostrarMarcadores;
      document.getElementById("filtroNombre").oninput = mostrarMarcadores;
    }

    function mostrarMarcadores() {
      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      const vendedoresSel = Array.from(document.querySelectorAll("#vendedorCheckboxes input:checked")).map(c => c.value);
      const gestorSel = document.getElementById("filtroGestor").value;
      const semanaSel = document.getElementById("filtroSemana").value;
      const diaSel = document.getElementById("filtroDia").value;
      const clienteSel = document.getElementById("filtroCliente").value;
      const condicionSel = document.getElementById("filtroCondicion").value;
      const texto = document.getElementById("filtroNombre").value.toLowerCase();

      const filtrados = datos.filter(d =>
        (vendedoresSel.length === 0 || vendedoresSel.includes(d["vendedor_asignado"])) &&
        (!gestorSel || d["gestor_servicio"] === gestorSel) &&
        (!semanaSel || d["semana"] === semanaSel) &&
        (!diaSel || d["dia_visita"] === diaSel) &&
        (!clienteSel || d["RazonSocial"] === clienteSel) &&
        (!condicionSel || d["condicion_ruta"] === condicionSel) &&
        (!texto || d["RazonSocial"].toLowerCase().includes(texto))
      );

      filtrados.forEach(d => {
        let lat = parseFloat(d.latitud?.replace(",", "."));
        let lng = parseFloat(d.longitud?.replace(",", "."));
        if (!isNaN(lat) && !isNaN(lng)) {
          const marcador = L.marker([lat, lng])
            .bindPopup(`<strong>${d.RazonSocial}</strong><br>${d.vendedor_asignado}`);
          marcador.addTo(mapa);
          marcadores.push(marcador);
        }
      });
    }

    function restaurarMapa() {
      document.querySelectorAll("#panel select, #panel input").forEach(el => {
        if (el.type === "checkbox") el.checked = true;
        else el.value = "";
      });
      mostrarMarcadores();
    }

    cargarDatos();
  </script>
</body>
</html>
