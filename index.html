
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Interactivo - Rutas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100%; }
    #panel-toggle {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: #007bff; color: white; padding: 10px; border-radius: 5px;
      font-weight: bold; cursor: pointer;
    }
    #panel {
      position: absolute; top: 50px; left: 10px; width: 280px; max-height: 90%;
      background: white; z-index: 1000; border-radius: 10px; overflow-y: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 10px; display: none;
    }
    #panel label { font-weight: bold; margin-top: 10px; display: block; }
    #panel select, #panel input {
      width: 100%; padding: 6px; margin-top: 3px; border-radius: 4px; border: 1px solid #ccc;
    }
    #panel button {
      margin-top: 10px; width: 100%; padding: 8px; font-weight: bold;
      background: #007bff; color: white; border: none; border-radius: 5px;
      cursor: pointer;
    }
    .leaflet-popup-content { font-size: 14px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel-toggle">☰ Filtros</div>
  <div id="panel">
    <label for="vendedor">Vendedor</label>
    <select id="vendedor"></select>

    <label for="gestor">Gestor</label>
    <select id="gestor"></select>

    <label for="semana">Semana</label>
    <select id="semana"></select>

    <label for="dia">Día</label>
    <select id="dia"></select>

    <label for="condicion">Condición</label>
    <select id="condicion"></select>

    <label for="buscar">Buscar Cliente</label>
    <input type="text" id="buscar" placeholder="Nombre del cliente..." />

    <label for="cliente">Cliente</label>
    <select id="cliente"></select>

    <button id="restaurar">Restaurar</button>
  </div>

  <script>
    const panelToggle = document.getElementById("panel-toggle");
    const panel = document.getElementById("panel");
    panelToggle.onclick = () => {
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    };

    const map = L.map('map').setView([18.7357, -70.1627], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let markers = [];
    let dataClientes = [];
    const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnmjSg8mtidztak7cO6Es8tOTRujAes62qA9gsu1FYn219IaLqBpkYlIgZJgDNcpKHATaG9tWqwrE7/pub?output=csv";

    function cargarDatos() {
      Papa.parse(urlCSV, {
        download: true,
        header: true,
        complete: (results) => {
          dataClientes = results.data.filter(r => r.latitud && r.longitud);
          cargarFiltros();
          mostrarClientes(dataClientes);
        },
        error: () => {
          alert("Error al cargar datos del mapa.");
        }
      });
    }

    function cargarFiltros() {
      const vendedorSel = document.getElementById("vendedor");
      const gestorSel = document.getElementById("gestor");
      const semanaSel = document.getElementById("semana");
      const diaSel = document.getElementById("dia");
      const condicionSel = document.getElementById("condicion");
      const clienteSel = document.getElementById("cliente");

      const setUnicos = (campo, select) => {
        const valores = [...new Set(dataClientes.map(c => c[campo]).filter(x => x))].sort();
        select.innerHTML = '<option value="">-- Todos --</option>';
        valores.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.text = v;
          select.appendChild(opt);
        });
      };

      setUnicos("vendedor", vendedorSel);
      setUnicos("gestor_servicio", gestorSel);
      setUnicos("semana", semanaSel);
      setUnicos("dia visita", diaSel);
      setUnicos("condicion", condicionSel);
      setUnicos("RazonSocial", clienteSel);
    }

    function mostrarClientes(lista) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      lista.forEach(c => {
        const marker = L.marker([parseFloat(c.latitud), parseFloat(c.longitud)]).addTo(map)
          .bindPopup("<b>" + c.RazonSocial + "</b><br>" + c.vendedor + " / " + c.gestor_servicio);
        markers.push(marker);
      });
    }

    document.getElementById("restaurar").onclick = () => {
      mostrarClientes(dataClientes);
    };

    document.querySelectorAll("#vendedor, #gestor, #semana, #dia, #condicion, #cliente").forEach(el => {
      el.addEventListener("change", () => {
        const fVend = vendedor.value;
        const fGes = gestor.value;
        const fSem = semana.value;
        const fDia = dia.value;
        const fCon = condicion.value;
        const fCli = cliente.value;
        const fBus = document.getElementById("buscar").value.toLowerCase();

        const filtrado = dataClientes.filter(c => {
          return (!fVend || c.vendedor === fVend) &&
                 (!fGes || c.gestor_servicio === fGes) &&
                 (!fSem || c.semana === fSem) &&
                 (!fDia || c["dia visita"] === fDia) &&
                 (!fCon || c.condicion === fCon) &&
                 (!fCli || c.RazonSocial === fCli) &&
                 (!fBus || c.RazonSocial.toLowerCase().includes(fBus));
        });
        mostrarClientes(filtrado);
      });
    });

    document.getElementById("buscar").addEventListener("input", () => {
      const ev = new Event("change");
      document.getElementById("cliente").dispatchEvent(ev);
    });

    cargarDatos();
  </script>
</body>
</html>
